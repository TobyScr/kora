# Implement Add barriers (manual & Kora) for COM-B Mapping

## Metadata
- **Labels:** `FE`, `stage-understand`, `has-figma`, `ready-for-dev`
- **Milestone:** 1.7 Com-B & Personas
- **Assignee:** unassigned
- **Blocked by:** #34 (Implement COM-B Mapping dashboard with barrier tables)

## Description
Wire up the "+ Add more" button below each COM-B category table to support two methods of adding barriers: **manual entry** via a form modal and **Kora AI generation** via a simulated progress indicator. Issue #34 renders the "+ Add more" button as a non-functional placeholder — this ticket makes it functional.

Clicking "+ Add more" shows a dropdown with "Fill manually" and "Generated by Kora" options. Manual opens a modal; Kora simulates a progress animation and auto-populates a new barrier with sample data.

## Design Reference
- Figma: https://www.figma.com/design/eeycVNYc6KVwk4cscwkPiF/v.2-Kora---Dev.-Design?node-id=549-100686&m=dev
- "+ Add more" dropdown: node `549:102003`
- Add Barrier modal (manual): node `549:100689`
- Kora generation state: node `549:142329`
- Toast (added): node `549:100698`
- Full dashboard context: node `549:139111`

## Requirements

### "+ Add more" Dropdown
- [ ] Clicking the "+ Add more" button below a category table opens a dropdown menu with two options:
  - **"Fill manually"** — pencil icon, opens the Add Barrier modal
  - **"Generated by Kora"** — sparkle/AI icon, triggers the Kora generation flow
- [ ] Clicking outside the dropdown dismisses it
- [ ] The dropdown appears above the button (or below, whichever fits — follow consistent positioning)
- [ ] Each category has its own independent "+ Add more" button — the new barrier is added to **that specific category**

### Manual Add — Add Barrier Modal
- [ ] Modal header: "+" icon + "Add Barrier" title + close (X) button
- [ ] **Barrier name field:**
  - Placeholder: "Add your Barrier here"
  - Maximum 100 characters
  - Character counter displayed (e.g., "0 / 100")
- [ ] **Description field:**
  - Placeholder: "Provide a description that supports the barrier"
  - No maximum character limit
  - Character counter displayed (shows current count only, e.g., "0")
- [ ] Both fields are **required** — the Add button is disabled when either field is empty
- [ ] Footer: "Cancel" button and "Add" button (primary style)
- [ ] On Add:
  1. Append new barrier to the end of the category's barrier list
  2. Assign the next sequential row number (e.g., if 3 barriers exist, new one is #4)
  3. New barrier is **not recommended** (`isRecommended: false`, `isSelected: false`)
  4. Close modal
  5. Show "Barrier added successfully" toast
- [ ] On Cancel / X / click outside: close modal without adding
- [ ] Follow existing patterns: `Modal`, `ModalHeader`, `ModalBody`, `ModalFooter`

### Kora AI Generation
- [ ] Selecting "Generated by Kora" triggers a **simulated generation** process:
  1. A **progress pill** appears at the bottom of the category's barrier table area (below the last row, above the "+ Add more" button)
  2. The pill shows: a spinner/loading icon + "Generating Barrier (XX%)" text
  3. Progress advances through stages: **0% → 25% → 50% → 75% → 100%** with timed delays (~500ms–1s per step, total ~3–4 seconds)
  4. **No cancel option** — generation always runs to completion
  5. On completion: progress pill disappears, new barrier row appears at the end of the category table
  6. Show "Barrier added successfully" toast
- [ ] The generated barrier uses **sample data** specific to each category (different from the initial sample data in #34):
  - **Capability sample data:**
    - "Limited Digital Literacy Skills" / "Many young people lack the ability to critically evaluate online sources, identify manipulation tactics, or distinguish credible information from misinformation."
    - "Difficulty Recognising Emotional Triggers" / "Youth struggle to identify when content is designed to provoke emotional reactions, making them more susceptible to sharing inflammatory material."
    - "Poor Conflict Resolution Knowledge" / "Limited understanding of constructive disagreement techniques leads to defaulting to aggressive or avoidant online communication styles."
  - **Opportunity sample data:**
    - "Algorithmic Amplification of Extreme Content" / "Social media algorithms prioritise engagement over accuracy, disproportionately surfacing sensational and divisive content to young audiences."
    - "Limited Access to Moderated Discussion Spaces" / "Few online platforms offer structured, safe spaces for youth to practise respectful debate and engage with diverse viewpoints."
    - "Normalisation of Toxic Behaviour in Peer Groups" / "Within certain online communities, aggressive language and pile-on behaviour are socially rewarded, creating pressure to participate."
  - **Motivation sample data:**
    - "Fear of Social Exclusion for Disagreeing" / "Young people may avoid challenging harmful content or group opinions due to fear of being ostracised or losing social standing."
    - "Desire for Instant Validation Through Outrage" / "Posting or sharing provocative content generates quick engagement metrics (likes, replies), reinforcing outrage-driven behaviour."
    - "Apathy Towards Long-Term Consequences" / "Youth may feel that online actions have no real-world impact, reducing motivation to engage thoughtfully or consider the effects of their behaviour."
- [ ] Each Kora generation picks the **next unused** sample barrier for that category. If all sample barriers have been used, cycle back or generate with a generic placeholder (e.g., "AI Generated Barrier" / "Description pending review.")
- [ ] Generated barriers are **not recommended** (`isRecommended: false`, `isSelected: false`)
- [ ] Row number is assigned sequentially (next after existing barriers)
- [ ] No maximum number of barriers per category

### Toast Notifications
- [ ] "Barrier added successfully" — success type, shown after both manual add and Kora generation
- [ ] Use existing `useToast()` hook and `showToast()` API (top-right position)

## Acceptance Criteria
- [ ] Clicking "+ Add more" shows a dropdown with "Fill manually" and "Generated by Kora" options
- [ ] Clicking outside the dropdown dismisses it
- [ ] "Fill manually" opens the Add Barrier modal with empty fields
- [ ] Barrier name enforces 100 character limit with visible counter
- [ ] Description shows character counter (no max)
- [ ] Add button is disabled when either field is empty
- [ ] Adding a barrier appends it to the correct category with the next row number
- [ ] User-added barriers have no `*` prefix or highlighted styling
- [ ] "Generated by Kora" shows a progress pill (0% → 25% → 50% → 75% → 100%)
- [ ] Generation completes automatically (~3–4 seconds) with no cancel option
- [ ] Generated barrier appears in the table with sample data specific to the category
- [ ] Success toast appears after both manual add and Kora generation
- [ ] Multiple barriers can be added to a category with no limit
- [ ] Row numbers stay sequential after additions
- [ ] Desktop only (no mobile responsive required)
- [ ] No TypeScript errors, no console errors

## Edge Cases & Error States
- **Adding to an empty category:** If all barriers were deleted (via Edit/Delete ticket), adding a new one should create row #1
- **Adding at character limit:** Typing stops or is truncated at 100 characters for barrier name
- **Kora generation while another is running:** Disable the "+ Add more" button for that category while generation is in progress to prevent multiple simultaneous generations
- **Kora sample data exhaustion:** If all 3 sample barriers for a category have been used by Kora, use a generic fallback ("AI Generated Barrier" / "Description pending review.")
- **Rapid clicking "Fill manually":** Only one modal should open at a time
- **Adding a barrier then immediately adding another:** State should correctly reflect the new barrier count for sequential numbering

## Technical Notes
- The "+ Add more" button is already rendered by #34 but non-functional. This ticket adds `onClick` handling and the dropdown
- State management: barrier additions happen at the page level in `brief/page.tsx`. Pass an `onAddBarrier(categoryId, barrier)` callback down to the category component
- The dropdown follows the same pattern as the kebab menu (useRef, click-outside, absolute positioning)
- For Kora generation, use a `generatingCategoryId` state at the section level to track which category is currently generating. Use `setTimeout` or `setInterval` to simulate progress steps
- Sample data for Kora generation should be defined as a constant (e.g., `KORA_GENERATED_BARRIER_DATA`) separate from the initial `SAMPLE_COM_B_DATA` in #34
- Track which sample barriers have been used per category to avoid duplicates (e.g., a counter or index per category)
- New barrier IDs: use a simple incrementing ID or `crypto.randomUUID()` for uniqueness

## Dependencies
- #34: COM-B Mapping dashboard (provides barrier tables, "+ Add more" button, state structure)
- Existing components: `Modal`, `ModalHeader`, `ModalBody`, `ModalFooter`, `Toast`/`useToast`

## Notes
- The progress pill ("Generating Barrier (25%)") is a new UI element not used elsewhere in the app. Keep it simple: a rounded pill with a spinner icon and text, styled to match the existing design system colours
- The "+ Add more" dropdown is distinct from the 3-dot actions menu — it has different options and appears in a different location, but follows the same dropdown pattern
